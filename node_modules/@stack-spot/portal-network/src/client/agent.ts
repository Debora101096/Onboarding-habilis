import { HttpError } from '@oazapfts/runtime'
import {
  defaults, deleteV1AgentByAgentIdFavorite, getV1AgentByAgentId, getV1Agents, getV1PublicAgentByAgentId, getV1PublicAgents,
  postV1AgentByAgentIdFavorite, putV1AgentByAgentId,
} from '../api/agent'
import { StackspotAPIError } from '../error/StackspotAPIError'
import { ReactQueryNetworkClient } from '../network/ReactQueryNetworkClient'
import { getApiAddresses } from '../api-addresses'

export const isAgentDefault = (agentSlug?: string) => agentSlug === 'stk_code_buddy'

interface AgentError {
  code?: string,
  details?: string,
  additionalInformation?: Record<string, any>,
}

class AgentClient extends ReactQueryNetworkClient {
  constructor() {
    super(getApiAddresses().agent.url, defaults)
  }

  protected buildStackSpotError(error: HttpError): StackspotAPIError {
    const errorData = error.data as AgentError | undefined
    const message = [errorData?.details]
    Object.keys(errorData?.additionalInformation ?? {}).forEach(k => message.push(`  - ${k}: ${errorData?.additionalInformation?.[k]}`))
    return new StackspotAPIError({
      status: error.status,
      headers: error.headers,
      stack: error.stack,
      code: error.data?.code,
      message: message.join('\n'),
    })
  }

  /** 
   * Gets an agent by id
   */
  agentById = this.query({
    name: 'agentById',
    request: (signal, variables: { agentId: string, builtIn: boolean }) => variables.builtIn
      ? getV1PublicAgentByAgentId({ ...variables }, { signal })
      : getV1AgentByAgentId({ ...variables }, { signal }),
  })

  /** 
   * List commons agents
   */
  agents = this.query(getV1Agents)

  /** 
   * Gets a common agent by id
   */
  agent = this.query(getV1AgentByAgentId)

  /** 
   * List all public agents (built-in)
   */
  publicAgents = this.query(getV1PublicAgents)

  /** 
   * Gets a public agent by id (built-in)
   */
  publicAgent = this.query(getV1PublicAgentByAgentId)

  /**
   * Adds the resource of type Agent to the list of favorites.
   */
  addFavoriteAgent = this.mutation(postV1AgentByAgentIdFavorite)

  /**
   * Removes the resource of type Agent from the list of favorites.
   */
  removeFavoriteAgent = this.mutation(deleteV1AgentByAgentIdFavorite)
  /**
   * Updates an agent
   */
  updateAgent = this.mutation(putV1AgentByAgentId)
}

export const agentClient = new AgentClient()
