import { Session } from '@stack-spot/auth'
import { useEffect, useState } from 'react'
import { SessionManager } from './SessionManager'

export function useSession() {
  const manager = SessionManager.instance
  const [session, setSession] = useState<Session | undefined>(manager?.hasSession() ? manager.getSession() : undefined)
  useEffect(() => {
    return manager?.onChange(setSession)
  }, [])
  return session
}

export type Provider = 'google' | 'github' | 'microsoft'
export const useTrialProviders = ({ enabled = true }): [Provider[], boolean] => {
  const [isLoadingTrialProviders, setIsLoadingTrialProviders] = useState<boolean>(enabled)
  const [trialProviders, setTrialProviders] = useState<Provider[]>([])

  useEffect(() => {
    (async () => {
      if (!SessionManager.instance || !enabled) return
      try {
        const providers = (await SessionManager.instance.getTrialEnabledProviders()) as Provider[]
        setTrialProviders(providers)
        setIsLoadingTrialProviders(false)
      } catch (error) {
        console.error(error)
        setIsLoadingTrialProviders(false)
      }
    })()
  }, [SessionManager.instance])

  return [trialProviders, isLoadingTrialProviders]
}
