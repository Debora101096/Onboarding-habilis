import { writeFile } from 'fs/promises'
import { glob } from 'glob'
import type { Plugin } from 'vite'
import { PrefetchMetadata } from '../types'

interface Config {
  out?: string,
}

export function mfePrefetch({ out }: Config = {}): Plugin {
  let outDir = ''
  let assetsDir = ''
  return {
    name: 'mfe-prefetch',
    apply: 'build',
    async configResolved(config) {
      outDir = config.build.outDir
      assetsDir = config.build.assetsDir
    },
    writeBundle: async () => {
      const files = await glob(`${outDir}/${assetsDir}/*.{js,png,svg}`)
      const content: PrefetchMetadata = {
        assetsDir,
        files: files.map(f => f.replace(new RegExp(`^${outDir}/${assetsDir}/`), '')),
      }
      await writeFile(
        out ?? `${outDir}/prefetch.json`,
        JSON.stringify(content),
        { encoding: 'utf-8' },
      )
    },
  }
}
