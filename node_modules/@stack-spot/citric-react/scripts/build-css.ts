import { readFile, writeFile } from 'fs/promises'
import { glob } from 'glob'
import yargs from 'yargs'
import { hideBin } from 'yargs/helpers'

interface Argv {
  o?: string,
  output?: string,
}

function getArguments() {
  const argv = yargs(hideBin(process.argv)).parse() as Argv
  const output = argv.o || argv.output || './dist'
  return { output }
}

async function readInput() {
  const themeFiles = await glob('../css/theme/**.css')
  const otherFiles = await glob('../css/**/**.css', { ignore: '../css/theme/**' })
  const themeCss: string[] = []
  const otherCss: string[] = []
  for (const f of themeFiles) {
    themeCss.push(await readFile(f, { encoding: 'utf8' }))
  }
  for (const f of otherFiles) {
    otherCss.push(await readFile(f, { encoding: 'utf8' }))
  }
  return { theme: themeCss.join('\n\n'), citric: otherCss.join('\n\n') }
}

async function start() {
  try {
    const { output } = getArguments()
    const { theme, citric } = await readInput()
    await Promise.all([
      writeFile(`${output}/theme.css`, theme, { encoding: 'utf8' }),
      writeFile(`${output}/citric.css`, citric, { encoding: 'utf8' }),
    ])
    // eslint-disable-next-line no-console
    console.log(`CSS built at ${output}`)
    process.exit(0)
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error(error)
    process.exit(1)
  }
}

start()
