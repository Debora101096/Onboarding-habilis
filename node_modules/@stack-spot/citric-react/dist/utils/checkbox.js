import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { defaultRenderKey } from './options.js';
/**
 * Use this hook to easily implement filtering and selection controls for a checkbox group.
 * @param params the parameters to create the controls.
 * @returns the checkbox controls.
 */
export function useCheckboxGroupControls(params) {
    const [value, setValue] = useState(params.initialValue ?? []);
    const [filter, setFilter] = useState();
    const previousValue = useRef(value);
    const renderKey = params.renderKey ?? defaultRenderKey;
    useEffect(() => {
        params.onChange?.(value, previousValue.current);
        previousValue.current = value;
    }, [value]);
    const { options, isUnfilteredButChecked } = useMemo(() => {
        if (!params.applyFilter || !filter)
            return { options: params.options, isUnfilteredButChecked: () => false };
        const filtered = [];
        const unfilteredButChecked = [];
        const map = new Map();
        const valueKeys = value.map(o => renderKey(o));
        for (const o of params.options) {
            const key = renderKey(o);
            if (params.applyFilter(filter, o))
                filtered.push(o);
            else if (valueKeys.includes(key)) {
                unfilteredButChecked.push(o);
                map.set(key, true);
            }
        }
        return { options: [...unfilteredButChecked, ...filtered], isUnfilteredButChecked: (o) => map.has(renderKey(o)) };
    }, [params.options, filter]);
    const selectAll = useCallback(() => {
        setValue([...options]);
    }, [options]);
    const removeSelection = useCallback(() => {
        setValue([]);
    }, []);
    return {
        /**
         * Selects all the options currently visible.
         */
        selectAll,
        /**
         * Removes all options from the selection.
         */
        removeSelection,
        /**
         * The current filter applied.
         */
        filter,
        /**
         * Apply a new filter.
         */
        setFilter,
        /**
         * The options that should be passed to the checkbox group.
         */
        options,
        /**
         * The value that should be passed to the checkbox group.
         */
        value,
        /**
         * Changes the current value, should be passed to the property `onChange` of the checkbox group.
         */
        setValue,
        /**
         * A function to render a unique key for an option. Should be passed to the property `renderKey` of the checkbox group.
         */
        renderKey,
        /**
         * A function that returns true if the option is filtered out, but checked.
         * @param option the option to check.
         * @returns true if the option was filtered out, but is checked; false otherwise.
         */
        isUnfilteredButChecked,
        /**
         * True if all options showing are selected, false otherwise.
         */
        isAllSelected: value.length === options.length,
    };
}
//# sourceMappingURL=checkbox.js.map