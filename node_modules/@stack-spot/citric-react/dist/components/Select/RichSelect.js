import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { listToClass } from '@stack-spot/portal-theme';
import { useTranslate } from '@stack-spot/portal-translate';
import { useCallback, useMemo, useRef, useState } from 'react';
import { applyCSSVariable } from '../../utils/css.js';
import { defaultRenderKey, defaultRenderLabel } from '../../utils/options.js';
import { withRef } from '../../utils/react.js';
import { CitricComponent } from '../CitricComponent.js';
import { Input } from '../Input.js';
import { ProgressCircular } from '../ProgressCircular.js';
import { useDisabledEffect, useFocusEffect, useOpenPanelEffect } from './hooks.js';
import { SimpleSelect } from './SimpleSelect.js';
export const RichSelect = withRef(function RichSelect({ ref, options, value, onChange, renderLabel = defaultRenderLabel, renderKey = defaultRenderKey, required = true, disabled, loading, renderOption, renderHeader, searchable, maxHeight, style, className, onFocus, onBlur, showArrow, placeholder, ...props }) {
    const [search, setSearch] = useState('');
    const _element = useRef(null);
    const element = ref ?? _element;
    const [open, setOpen] = useState(false);
    const [focused, setFocused] = useState(false);
    const t = useTranslate(dictionary);
    const change = useCallback((option) => () => {
        onChange?.(option);
        setOpen(false);
    }, []);
    const renderedOptions = useMemo(() => {
        const items = required
            ? []
            : [_jsx("li", { className: "empty option", onClick: change(undefined), children: renderLabel(undefined) || t.empty }, "")];
        options.forEach((o) => {
            const key = renderKey(o);
            const label = renderLabel(o);
            if (!search?.trim() || label.toLocaleLowerCase().includes(search?.trim().toLocaleLowerCase())) {
                items.push(_jsx("li", { onClick: change(o), className: "option", children: renderOption?.(o) ?? label }, key));
            }
        });
        return items;
    }, [options, value, required, search]);
    useOpenPanelEffect({ open, setOpen, setSearch, element, searchable });
    useFocusEffect({ element, focused, setFocused, setOpen });
    useDisabledEffect({ disabled, setOpen, setFocused });
    return (_jsxs(CitricComponent, { tag: "div", component: "rich-select", style: maxHeight ? applyCSSVariable(style, 'max-height', `${maxHeight}px`) : style, className: listToClass([className, showArrow === false && 'hide-arrow', open && 'open', focused && 'focused']), ref: element, "aria-busy": loading, ...props, children: [_jsx(SimpleSelect, { options: options, value: value, renderLabel: renderLabel, renderKey: renderKey, required: required, disabled: disabled, onChange: onChange, onFocus: onFocus, onBlur: onBlur, wrap: false }), _jsxs("header", { onClick: () => {
                    if (disabled)
                        return;
                    setFocused(true);
                    setOpen(true);
                }, "aria-hidden": true, children: [value === undefined
                        ? _jsx("span", { className: "placeholder header-text", children: placeholder })
                        : (renderHeader?.(value) ?? _jsx("span", { className: "header-text", children: renderOption?.(value) ?? renderLabel(value) })), loading && _jsx(ProgressCircular, { size: "xs", className: "loader" })] }), _jsxs("div", { className: "selection-panel", "aria-hidden": true, children: [searchable && _jsx("div", { className: "search-bar", children: _jsxs("div", { "data-citric": "field-group", className: "auto", children: [_jsx("i", { "data-citric": "icon-box", className: "citric-icon outline Search" }), _jsx(Input, { type: "search", value: search, onChange: setSearch, tabIndex: -1 })] }) }), _jsx("ul", { className: "options", children: renderedOptions })] })] }));
});
const dictionary = {
    en: {
        empty: 'Empty',
    },
    pt: {
        empty: 'Vazio',
    },
};
//# sourceMappingURL=RichSelect.js.map