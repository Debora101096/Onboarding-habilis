import { MutableRefObject, useCallback, useMemo } from 'react'
import { defaultRenderKey, defaultRenderLabel } from '../../utils/options'
import { withRef } from '../../utils/react'
import { CitricComponent } from '../CitricComponent'
import { ProgressCircular } from '../ProgressCircular'
import { SelectProps } from './types'

export const SimpleSelect = withRef(
  function SimpleSelect<T>({
    ref,
    options,
    value,
    onChange,
    renderLabel = defaultRenderLabel,
    renderKey = defaultRenderKey,
    required = true,
    loading,
    disabled,
    onBlur,
    onFocus,
    wrap,
    ...props
  }: SelectProps<T> & { wrap?: boolean },
  ) {
    const handleChange = useCallback((e: React.ChangeEvent<HTMLSelectElement>) => {
      const selectedIndex = e.target.options.selectedIndex - (e.target.options.length > options.length ? 1 : 0)
      onChange?.(selectedIndex >= 0 ? options[selectedIndex] : undefined)
    }, [options])

    const renderedOptions = useMemo(() => {
      const items = (!value || !required) ? [<option key="">{renderLabel(undefined)}</option>] : []
      options.forEach((o) => {
        const key = renderKey(o)
        items.push(
          <option key={key} value={key}>
            {renderLabel(o)}
          </option>,
        )
      })
      return items
    }, [options, value, required])

    return wrap === false ? (
      <CitricComponent
        tag="select"
        ref={ref as MutableRefObject<HTMLSelectElement | null>}
        required={required}
        onChange={handleChange}
        disabled={disabled || loading}
        component="select"
        onFocus={onFocus}
        onBlur={onBlur}
        value={value ? renderKey(value) : ''}
      >
        {renderedOptions}
      </CitricComponent>
    ) : (
      <CitricComponent ref={ref as MutableRefObject<HTMLDivElement | null>} tag="div" component="select" aria-busy={loading} {...props}>
        <select
          value={value ? renderKey(value) : undefined}
          required={required}
          onChange={handleChange}
          disabled={disabled || loading}
          onFocus={onFocus}
          onBlur={onBlur}
        >
          {renderedOptions}
        </select>
        {loading && <ProgressCircular className="loader" size="xs" />}
      </CitricComponent>
    )
  },
)
