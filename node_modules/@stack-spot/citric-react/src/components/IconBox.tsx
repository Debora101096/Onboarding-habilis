import { BaseIconProps, IconGroup } from '@stack-spot/citric-icons'
import { listToClass } from '@stack-spot/portal-theme'
import { useCitricController } from '../context/hooks'
import { HTMLTag, WithColorPalette, WithColorScheme } from '../types'
import { withRef } from '../utils/react'
import { asCitricProps, CitricComponent } from './CitricComponent'

type IconBoxTag = 'a' | 'button' | 'i' | 'span' | 'div'

export interface BaseIconBoxProps<T extends IconBoxTag, G extends IconGroup> extends BaseIconProps<G>, WithColorScheme, WithColorPalette {
  /**
   * The HTML element to render.
   * 
   * @default 'i'
   */
  tag?: T,
  /**
   * The box appearance.
   * 
   * - circle: a circle with a background color. Its size depends on the value of `size`. If this is clickable, the background and
   * foreground colors change on hover or focus.
   * - square: a square with rounded corners and a background color. Its size depends on the value of `size`. If this is clickable, the
   * background and foreground colors change on hover or focus.
   * - text: a circle with transparent background. Its size depends on the value of `size`. If this is clickable, the background and
   * foreground colors change on hover or focus (it won't be transparent).
   * - none: no special styling, its size depends only on the size of the icon (the property `size` is ignored). Even if this is clickable,
   * the style doesn't change on hover or focus.
   * 
   * @default 'circle'
   */
  appearance?: 'circle' | 'square' | 'text' | 'none',
  /**
   * Size of the box.
   * 
   * - xs: 20px;
   * - sm: 24px;
   * - md: 32px;
   * - lg: 40px.
   * 
   * @default 'sm'
   */
  size?: 'xs' | 'sm' | 'md' | 'lg',
  /**
   * Animated text to show on when the button/link is clicked. This is only valid for buttons and anchors.
   */
  feedback?: string,
  /**
   * Only valid if `tag` is "button" or "a".
   * 
   * Metadata for the general onClick event, set by the CitricController. Useful for creating analytics data.
   * 
   * This only takes effect if there's a CitricController in React's context. The value of `metadata` is passed to the function
   * `onClickButton/onClickLink` of the controller.
   * 
   * @default false
   */
  metadata?: any,
}

export type IconBoxProps<T extends IconBoxTag, G extends IconGroup> = Omit<HTMLTag[T], 'children'> & BaseIconBoxProps<T, G>

/**
 * Renders a wrapper for an icon. The icon must specified by the properties "icon" and "group", this component accepts no children.
 * 
 * If you don't need the icon to be rendered within a box, consider using the component "Icon" directly.
 * 
 * Hover and focus effects are applied if the IconBox is focusable.
 * 
 * @example
 * ```
 * <IconBox icon="Search" colorScheme="primary" />
 * ```
 */
export const IconBox = withRef(
  function IconBox<T extends IconBoxTag = 'i', G extends IconGroup = 'outline'>(
    { group, icon, tag, appearance, size, className, metadata, onClick, feedback, ...props }: IconBoxProps<T, G>,
  ) {
    props['aria-label'] ||= props.title // accessibility
    const citric = useCitricController()

    function handleClick(e: React.MouseEvent<any>) {
      onClick?.(e)
      if (tag === 'button') citric?.onClickButton?.(e, metadata)
      else if (tag === 'a') citric?.onClickLink?.(e, metadata)
    }

    const componentProps = {
      tag: (tag || 'i') as any,
      component: 'icon-box',
      className: listToClass(['citric-icon', group || 'outline', icon, appearance, size, className]),
      'data-feedback': feedback || undefined,
      onClick: ['button', 'a'].includes(tag ?? '') ? handleClick : onClick,
      ...props,
    } as const

    return tag === 'a' && citric?.renderLink
      ? citric.renderLink(asCitricProps(componentProps))
      : <CitricComponent {...componentProps} />
  },
)

/**
 * A shortcut for `<IconBox tag="button">`.
 * 
 * Whenever a button is clicked, the function `onClickButton` of the nearest CitricController is called with the event and the value of the
 * prop `metadata`.
 * 
 * @example
 * ```
 * <IconButton icon="Search" />
 * ```
 */
export const IconButton = withRef(
  function IconButton<G extends IconGroup = 'outline'>({ type, ...props }: Omit<IconBoxProps<'button', G>, 'tag'>) {
    return <IconBox {...props} tag="button" type={type || 'button' } />
  },
)

/**
 * A shortcut for `<IconBox tag="a">`.
 * 
 * Whenever a link is clicked, the function `onClickLink` of the nearest CitricController is called with the event and the value of the
 * prop `metadata`.
 * 
 * @example
 * ```
 * <IconLink icon="Search" href="#" />
 * ```
 */
export const IconLink = withRef(
  function IconLink<G extends IconGroup = 'outline'>(props: Omit<IconBoxProps<'a', G>, 'tag'>) {
    return <IconBox {...props} tag="a" />
  },
)
