import { Box, Flex } from '@citric/core'
import { LoadingCircular } from '@citric/ui'
import { useEffect, useMemo, useState } from 'react'

export interface TypeFormProps {
  dataTfLive: string,
  hiddenProps?: Record<string, string | number>,
}

export const TypeForm = ({
  dataTfLive,
  hiddenProps,
}: TypeFormProps) => {


  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    (window as any).tf?.load()
    setTimeout(() => {
      setIsLoading(false)
    }, 2000)
  }, [])

  const hiddenPropsString = useMemo(() => {
    if (hiddenProps) {
      return Object.entries(hiddenProps)
        .map(([key, value]) => `${key}=${value}`)
        .join(',')
    }
  }, [hiddenProps])

  const typeform = useMemo(() => <Box>
    <div
      data-tf-live={dataTfLive}
      data-tf-hidden={hiddenPropsString}
    />
  </Box>, [dataTfLive, hiddenPropsString])

  return (
    <Box sx={{ minWidth: '650px', minHeight: '500px' }}>
      {isLoading && <Flex alignItems="center" justifyContent="center" w="12" sx={{ height: '100%' }}>
        <LoadingCircular />
      </Flex>}
      <Box sx={{ opacity: isLoading ? '0' : 1 }}>
        {typeform}
      </Box>
    </Box>
  )
}
