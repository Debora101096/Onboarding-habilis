import { FetchRequest } from '../types'
import { Interceptor } from './InterceptorManager'

export class InterceptorRetry implements Interceptor {
  private maxRetrials: number
  private retryDelay: number
  private originalFetch: typeof fetch

  constructor(maxRetrials: number, retryDelay: number, originalFetch: typeof fetch) {
    this.maxRetrials = maxRetrials
    this.retryDelay = retryDelay
    this.originalFetch = originalFetch
  }

  /**
   * Intercepts the response in order to perform retrials in case of errors.
   * 
   * @param response the original response.
   * @param request the request.
   * @param retrials the number of retrials already performed.
   * @returns the retried response.
   */
  async interceptResponse(response: Response, request: FetchRequest, retrials = 0): Promise<Response> {
    if (response.ok || retrials >= this.maxRetrials || request.init?.signal?.aborted) return response
    await new Promise<void>((resolve) => {
      const timeout = setTimeout(resolve, this.retryDelay)
      request.init?.signal?.addEventListener('abort', () => {
        clearTimeout(timeout)
        resolve()
      })
    })
    if (request.init?.signal?.aborted) return response
    const newResponse = await this.originalFetch(request.url, request.init)
    return this.interceptResponse(newResponse, request, retrials + 1)
  }
}